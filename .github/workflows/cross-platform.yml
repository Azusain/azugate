name: Azugate Linux CI/CD

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-22.04
    
    strategy:
      fail-fast: false
      matrix:
        # Single build for maximum speed - GCC Release only
        include:
          - compiler: gcc
            cc: gcc-11
            cxx: g++-11
            build_type: Release
    
    env:
      CC: ${{ matrix.cc }}
      CXX: ${{ matrix.cxx }}
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    # Multi-level aggressive caching strategy
    - name: Cache vcpkg Binary Cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/vcpkg/archives
          ~/.cache/vcpkg/downloads
        key: ${{ runner.os }}-vcpkg-binary-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-binary-
    
    - name: Cache vcpkg Installation
      uses: actions/cache@v4
      with:
        path: |
          vcpkg_installed
          vcpkg
        key: ${{ runner.os }}-vcpkg-install-${{ matrix.compiler }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-install-${{ matrix.compiler }}-
          ${{ runner.os }}-vcpkg-install-
    
    - name: Cache Build Directory
      uses: actions/cache@v4
      with:
        path: |
          build/CMakeFiles
          build/CMakeCache.txt
          build/*.ninja
          build/.ninja*
        key: ${{ runner.os }}-build-${{ matrix.compiler }}-${{ matrix.build_type }}-${{ hashFiles('CMakeLists.txt', 'src/**/*.cpp', 'src/**/*.cc', 'src/**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ matrix.compiler }}-${{ matrix.build_type }}-
          ${{ runner.os }}-build-${{ matrix.compiler }}-
    
    - name: Install System Dependencies (Cached)
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: build-essential cmake ninja-build git pkg-config curl zip unzip tar ${{ matrix.cc }} ${{ matrix.cxx }}
        version: 1.0
    
    - name: Setup vcpkg (Optimized)
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'cd124b84feb0c02a24a2d90981e8358fdee0e077'
        runVcpkgInstall: true
        # Enable binary caching
        appendedCacheKey: ${{ matrix.compiler }}
        # Use pre-built binaries when possible
        vcpkgJsonGlob: 'vcpkg.json'
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_C_COMPILER=${{ matrix.cc }} \
          -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
          -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake \
          -G Ninja
    
    - name: Build Project
      run: |
        cmake --build build --config ${{ matrix.build_type }} --parallel $(nproc)
    
    - name: Verify Build Artifacts
      run: |
        echo "=== Build Artifacts ==="
        ls -la build/
        file build/azugate
        ldd build/azugate || echo "Static linking detected"
        
        echo "=== Binary Information ==="
        size build/azugate
        
        echo "=== Testing Executable ==="
        timeout 10s build/azugate --help || echo "Help command test completed"
    
    - name: Run Unit Tests
      if: matrix.build_type == 'Release'
      run: |
        cd build
        ctest --output-on-failure --parallel $(nproc) || echo "No tests configured"
    
    - name: Performance Benchmark
      if: matrix.build_type == 'Release' && matrix.compiler == 'gcc'
      run: |
        echo "=== Performance Metrics ==="
        echo "Binary size: $(stat -c%s build/azugate) bytes"
        echo "Stripped size: $(strip --strip-all build/azugate -o build/azugate_stripped && stat -c%s build/azugate_stripped) bytes"
    
    - name: Upload Build Artifacts
      if: matrix.build_type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: azugate-linux-${{ matrix.compiler }}-${{ matrix.build_type }}
        path: |
          build/azugate
          build/*.so*
        retention-days: 7
    
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.compiler }}-${{ matrix.build_type }}
        path: |
          build/Testing/
          build/*.log
        retention-days: 3
        if-no-files-found: ignore

  security-scan:
    name: Security Scan
    runs-on: ubuntu-22.04
    needs: build-and-test
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: azugate-linux-gcc-Release
        path: ./artifacts
    
    - name: Run Security Scan
      run: |
        echo "=== Security Analysis ==="
        
        # Check for hardcoded secrets
        echo "Checking for potential secrets..."
        grep -r -i "password\|secret\|key\|token" src/ || echo "No obvious secrets found"
        
        # Basic binary analysis
        echo "Analyzing binary security features..."
        if command -v checksec &> /dev/null; then
          checksec --file=./artifacts/azugate
        else
          echo "checksec not available, skipping binary security analysis"
        fi
        
        # Check dependencies for known vulnerabilities
        echo "Dependency analysis..."
        ldd ./artifacts/azugate | head -20

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Verify Documentation
      run: |
        echo "=== Documentation Verification ==="
        
        # Check if documentation files exist
        required_docs=(
          "README.md"
          "BUILD.README.md"
          "LINUX_BUILD.md"
          "GRPC_INTEGRATION_FIXES.md"
        )
        
        for doc in "${required_docs[@]}"; do
          if [[ -f "$doc" ]]; then
            echo "‚úÖ $doc exists ($(wc -l <"$doc") lines)"
          else
            echo "‚ùå $doc is missing"
            exit 1
          fi
        done
        
        # Check if vcpkg manifest is valid
        echo "Verifying vcpkg configuration..."
        if [[ -f "vcpkg.json" ]]; then
          echo "‚úÖ vcpkg.json exists"
          cat vcpkg.json | jq . > /dev/null && echo "‚úÖ vcpkg.json is valid JSON"
        fi
        
        if [[ -f "vcpkg-configuration.json" ]]; then
          echo "‚úÖ vcpkg-configuration.json exists"
          cat vcpkg-configuration.json | jq . > /dev/null && echo "‚úÖ vcpkg-configuration.json is valid JSON"
        fi

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-22.04
    needs: build-and-test
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Download Linux Artifact
      uses: actions/download-artifact@v4
      with:
        name: azugate-linux-gcc-Release
        path: ./linux-build
    
    - name: Setup Test Environment
      run: |
        chmod +x ./linux-build/azugate
        
        # Create test configuration
        mkdir -p test-env
        cd test-env
        
        # Basic configuration file
        cat > config.yaml << EOF
        server:
          port: 8080
          grpc_port: 50051
        logging:
          level: info
        EOF
    
    - name: Run Integration Tests
      timeout-minutes: 2
      run: |
        cd test-env
        
        echo "=== Starting Integration Tests ==="
        
        # Test 1: Configuration validation
        echo "Testing configuration validation..."
        timeout 5s ../linux-build/azugate --config config.yaml --validate || echo "Config validation test completed"
        
        # Test 2: Service startup (background)
        echo "Testing service startup..."
        timeout 10s ../linux-build/azugate --config config.yaml &
        SERVER_PID=$!
        sleep 3
        
        # Test 3: Health check
        if kill -0 $SERVER_PID 2>/dev/null; then
          echo "‚úÖ Server started successfully"
          
          # Test gRPC port (if available)
          if command -v nc >/dev/null; then
            nc -z localhost 50051 && echo "‚úÖ gRPC port accessible" || echo "‚ö†Ô∏è gRPC port not accessible"
          fi
          
          # Test HTTP port (if available)
          if command -v nc >/dev/null; then
            nc -z localhost 8080 && echo "‚úÖ HTTP port accessible" || echo "‚ö†Ô∏è HTTP port not accessible"
          fi
          
          # Cleanup
          kill $SERVER_PID 2>/dev/null || echo "Server already stopped"
        else
          echo "‚ùå Server failed to start"
        fi

  release:
    name: Create Release
    runs-on: ubuntu-22.04
    needs: [build-and-test, integration-test]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./release-artifacts
    
    - name: Prepare Release Assets
      run: |
        cd release-artifacts
        
        # Create Linux release package
        for dir in */; do
          if [[ -d "$dir" ]]; then
            echo "Processing $dir..."
            cd "$dir"
            
            # Find executables and create archives (Linux only)
            if ls azugate* > /dev/null 2>&1; then
              tar -czf "../${dir%/}.tar.gz" *
            fi
            cd ..
          fi
        done
        
        ls -la *.tar.gz || echo "No release packages created"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-artifacts/*.tar.gz
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(github.ref, '-') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  discord-notification:
    name: Discord Notification
    runs-on: ubuntu-22.04
    needs: [build-and-test, security-scan, documentation-check, integration-test, release]
    if: always()
    
    steps:
    - name: Send Discord Notification
      uses: Ilshidur/action-discord@master
      with:
        args: |
          üöÄ **Azugate Linux CI/CD Complete!**
          
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Workflow:** ${{ github.workflow }}
          
          **Build & Test:** ${{ needs.build-and-test.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }}
          **Security Scan:** ${{ needs.security-scan.result == 'success' && '‚úÖ Clean' || needs.security-scan.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Issues' }}
          **Documentation:** ${{ needs.documentation-check.result == 'success' && '‚úÖ Valid' || '‚ùå Missing' }}
          **Integration Tests:** ${{ needs.integration-test.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}
          **Release:** ${{ needs.release.result == 'success' && '‚úÖ Created' || needs.release.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}
          
          **Triggered by:** ${{ github.actor }}
          **View Details:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
